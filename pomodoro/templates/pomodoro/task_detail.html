<!-- pomodoro/templates/pomodoro/task_detail.html -->
{% extends 'core/base.html' %}
{% load static %}

{% block title %}–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: {{ task.title }} - Pomodoro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'pomodoro/css/timer.css' %}">
{% endblock %}

{% block content %}
<div class="pomodoro-page">
    <!-- –®–∞–ø–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–¥–∞—á–µ -->
    <div class="pomodoro-header">
        <div class="container">
            <div class="task-info-card">
                <!-- –£–±—Ä–∞–ª–∏ –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å —Å —Å—á–µ—Ç—á–∏–∫–æ–º Pomodoro -->
                <div class="task-main-info" style="text-align: center; width: 100%;">
                    <h1 class="task-title">{{ task.title }}</h1>

                    <div class="task-meta-tags" style="justify-content: center;">
                        {% if task.quadrant %}
                        <span class="quadrant-tag" style="background-color: {{ task.quadrant.color_code|default:'#4ECDC4' }}">
                            {{ task.quadrant.name }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="pomodoro-main-layout">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢–∞–π–º–µ—Ä -->
            <div class="timer-column">
                <div class="timer-card">
                    <!-- –ö—Ä—É–≥–ª—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–∞–π–º–µ—Ä–∞ -->
                    <div class="timer-circle" id="timer-circle">
                        <div class="timer-display">
                            <div class="timer-time" id="timer-display">25:00</div>
                            <div class="timer-phase" id="timer-phase">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                        </div>
                    </div>

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–º -->
                    <div class="timer-controls">
                        <button class="timer-btn btn-start" id="start-timer">
                            <span class="btn-icon">‚ñ∂</span>
                            <span class="btn-text">–ù–∞—á–∞—Ç—å Pomodoro</span>
                        </button>

                        <div class="secondary-controls">
                            <button class="timer-btn btn-pause" id="pause-timer" disabled>
                                <span class="btn-icon">‚è∏</span>
                                <span class="btn-text">–ü–∞—É–∑–∞</span>
                            </button>
                            <button class="timer-btn btn-stop" id="stop-timer">
                                <span class="btn-icon">‚èπ</span>
                                <span class="btn-text">–°—Ç–æ–ø</span>
                            </button>
                            <button class="timer-btn btn-skip" id="skip-timer" disabled>
                                <span class="btn-icon">‚è≠</span>
                                <span class="btn-text">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ -->
            <div class="task-details-column">
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
                {% if task.description %}
                <div class="detail-card">
                    <h3 class="detail-title">
                        <span class="icon">üìù</span>
                        –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                    </h3>
                    <div class="detail-content">
                        <p>{{ task.description }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
                <div class="detail-card">
                    <h3 class="detail-title">
                        <span class="icon">üìä</span>
                        –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                    </h3>
                    <div class="detail-content">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="task-progress-bar"
                                     style="width: {% if task.estimated_pomodoros > 0 %}{{ task.completed_pomodoros|floatformat:0 }}{% else %}0{% endif %}%">
                                </div>
                            </div>
                            <div class="progress-text" id="progress-text">
                                –í—ã–ø–æ–ª–Ω–µ–Ω–æ <span class="completed">{{ task.completed_pomodoros }}</span> –∏–∑
                                <span class="total">{{ task.estimated_pomodoros }}</span> Pomodoro
                            </div>
                        </div>

                        <!-- –û—Ü–µ–Ω–∫–∞ Pomodoro -->
                        <div class="pomodoro-estimation">
                            <label for="estimated-pomodoros">–û—Ü–µ–Ω–∏—Ç–µ –∑–∞–¥–∞—á—É –≤ Pomodoro:</label>
                            <div class="estimation-control">
                                <input type="number" id="estimated-pomodoros"
                                       value="{{ task.estimated_pomodoros }}"
                                       min="1" max="20" class="estimation-input">
                                <span class="estimation-label">Pomodoro</span>
                                <button class="btn-save-estimation" id="save-estimation-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </div>

                        <!-- –î–µ–π—Å—Ç–≤–∏—è –ø–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º -->
                        <div class="actions-container">
                            <div class="action-buttons">
                                <a href="{% url 'tasks:matrix' %}" class="action-btn btn-back">
                                    <span class="btn-icon">‚Üê</span>
                                    –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–∞—Ç—Ä–∏—Ü–µ
                                </a>
                                <button class="action-btn btn-complete" id="complete-task-btn">
                                    <span class="btn-icon"></span>
                                    –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
<div id="notification" class="notification hidden">
    <div class="notification-content">
        <span id="notification-message"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ JavaScript -->
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è JavaScript
    window.settingsData = {
        workDuration: {{ settings.pomodoro_duration }},
        shortBreak: {{ settings.short_break_duration }},
        longBreak: {{ settings.long_break_duration }},
        cyclesBeforeLongBreak: {{ settings.pomodoros_before_long_break }}
    };

    window.taskData = {
        id: {{ task.id }},
        title: "{{ task.title|escapejs }}",
        completed_pomodoros: {{ task.completed_pomodoros }},
        estimated_pomodoros: {{ task.estimated_pomodoros }},
        quadrant: {% if task.quadrant %}{
            id: {{ task.quadrant.id }},
            name: "{{ task.quadrant.name|escapejs }}",
            color_code: "{{ task.quadrant.color_code|escapejs }}"
        }{% else %}null{% endif %}
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    window.getCSRFToken = function() {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfInput ? csrfInput.value : '';
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...');

        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
        const progressBar = document.getElementById('task-progress-bar');
        const completed = {{ task.completed_pomodoros }};
        const estimated = {{ task.estimated_pomodoros }};

        if (progressBar) {
            const percentage = estimated > 0 ? (completed / estimated) * 100 : 0;
            progressBar.style.width = `${Math.min(percentage, 100)}%`;
            console.log('üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', completed + '/' + estimated, '=', percentage.toFixed(1) + '%');
        }
    });
</script>

<script src="{% static 'pomodoro/js/timer.js' %}"></script>
<script src="{% static 'pomodoro/js/task_actions.js' %}"></script>
{% endblock %}